{% macro avatar_filename(user) %}
    {% if user.avatar %}
        {{ url_for("static", filename=("img/avatars/" + user.avatar)) }}
    {% else %}
        {{ url_for("static", filename="img/default_avatar.png") }}
    {% endif %}
{% endmacro %}

{% macro datetime_to_string(dt) %}
    {{ dt.strftime("%d %b %Y в %H:%M") }}
{% endmacro %}

{% macro like_btn(likes_count, is_liked, url, redirect_url) %}
    <a href="{{ url }}?redirect_url={{ redirect_url }}" class="btn
        {% if is_liked %}
            btn-danger
        {% else %}
            btn-secondary
        {% endif %}">Лайков: {{ likes_count }}</a>
{% endmacro %}

{% macro article_card(article, current_user, url="/") %}
    <div class="card article-card" id="articleCard{{ article.id }}">
        <div class="card-header">
            <h4 class="card-title">
                <img src="{{ avatar_filename(article.user) }}" alt="" width="48" height="48">
                <a href="/user_page/{{ article.author }}">@{{ article.user.nickname }}</a>
                {{ article.title }}
                {% if current_user == article.user %}
                    <span style="float: right">
                        <a href="/edit_article/{{ article.id }}"
                           class="btn btn-warning">Изменить статью</a>
                        <a href="/delete_article/{{ article.id }}"
                           class="btn btn-danger">Удалить статью</a>
                    </span>
                {% endif %}
            </h4>
            <h6 class="card-subtitle mb-2 text-muted">Опубликовано {{ datetime_to_string(article.create_date) }}</h6>
        </div>
        {% if article.image %}
            <img src="{{ url_for('static', filename='img/articles_images/' + article.image) }}"
                 alt="" style="max-width: 40%" class="card-img-top">
        {% endif %}
        <div class="card-body">
            <p class="card-text preserve-line-breaks">{{ article.content|truncate(255) }}</p>
            <a href="/article/{{ article.id }}" class="card-link">Перейти к статье</a>
        </div>
        <div class="card-footer">
            {{ like_btn(article.likes|length,
                        current_user is in(article.likes|map(attribute='user')),
                        "/like/" + article.id|string,
                        url) }}
        </div>
    </div>
{% endmacro %}

{% macro comment_card(comment, current_user) %}
    <div class="card comment-card">
        <div class="card-header">
            <h5 class="card-title">
                <img src="{{ avatar_filename(comment.user) }}" alt="" width="48" height="48">
                <a href="/user_page/{{ comment.author }}">@{{ comment.user.nickname }}</a>
                {% if current_user == comment.user %}
                    <span style="float: right">
                        <a href="/edit_comment/{{ comment.id }}"
                           class="btn btn-warning">Изменить</a>
                        <a href="/delete_comment/{{ comment.id }}"
                           class="btn btn-danger">Удалить</a>
                    </span>
                {% endif %}
            </h5>
            <h6 class="card-subtitle mb-2 text-muted">Опубликовано {{ datetime_to_string(comment.create_date) }}</h6>
        </div>
        {% if comment.image %}
            <img src="{{ url_for('static', filename='img/comments_images/' + comment.image) }}"
                 alt="" style="max-width: 25%" class="card-img-top">
        {% endif %}
        <div class="card-body">
            <p class="card-text preserve-line-breaks">{{ comment.text }}</p>
        </div>
    </div>
{% endmacro %}

{% macro pagination_widget(page_index, max_page_index, page_links_count, link_format) %}
    <ul class="pagination">
        {% if max_page_index <= page_links_count %}
            {% set min_link_index = 1 %}
            {% set max_link_index = max_page_index %}
        {% else %}
            {% if page_index <= page_links_count // 2 + 1 %}
                {% set min_link_index = 1 %}
                {% set max_link_index = page_links_count %}
            {% elif max_page_index - page_index + 1 <= page_links_count // 2 + 1 %}
                {% set min_link_index = max_page_index - page_links_count + 1 %}
                {% set max_link_index = max_page_index %}
            {% else %}
                {% set min_link_index = page_index - page_links_count // 2 %}
                {% set max_link_index = page_index + page_links_count // 2 %}
            {% endif %}
        {% endif %}
        {% if min_link_index > 1 %}
            <li class="page-item">
                <a href="{{ link_format|replace('$i', '1') }}" class="page-link">First</a>
            </li>
        {% endif %}
        {% if page_index > 1 %}
            <li class="page-item">
                <a href="{{ link_format|replace('$i', (page_index - 1)|string) }}"
                   class="page-link">&laquo;</a>
            </li>
        {% endif %}
        {% for i in range(min_link_index, max_link_index + 1) %}
            <li class="page-item {% if i == page_index %}disabled{% endif %}">
                <a href="{{ link_format|replace('$i', i|string) }}"
                   class="page-link">{{ i }}</a>
            </li>
        {% endfor %}
        {% if page_index < max_page_index %}
            <li class="page-item">
                <a href="{{ link_format|replace('$i', (page_index + 1)|string) }}"
                   class="page-link">&raquo;</a>
            </li>
        {% endif %}
        {% if max_link_index < max_page_index %}
            <li class="page-item">
                <a href="{{ link_format|replace('$i', max_page_index|string) }}"
                   class="page-link">Last</a>
            </li>
        {% endif %}
    </ul>
{% endmacro %}
